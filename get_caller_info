But : retrouver un client à partir de son numéro de téléphone (ou external_id), pour CallRounded.

import logging
import os
import json

import azure.functions as func
import mysql.connector


def _get_db_connection():
    """Retourne une connexion à la base MySQL."""
    return mysql.connector.connect(
        host=os.environ["MYSQL_HOST"],
        database=os.environ["MYSQL_DB"],
        user=os.environ["MYSQL_USER"],
        password=os.environ["MYSQL_PASSWORD"],
    )


def main(req: func.HttpRequest) -> func.HttpResponse:
    logging.info("get_caller_info - Requête reçue.")

    # Récupération du numéro de téléphone
    phone = req.params.get("phone")
    if not phone:
        try:
            body = req.get_json()
        except ValueError:
            body = {}
        phone = body.get("phone")

    if not phone:
        return func.HttpResponse(
            json.dumps({"error": "Missing 'phone' parameter"}),
            status_code=400,
            mimetype="application/json",
        )

    try:
        conn = _get_db_connection()
        cursor = conn.cursor(dictionary=True)

        query = """
        SELECT id, external_id, name, email, phone, company_name
        FROM customers
        WHERE phone = %s OR external_id = %s
        LIMIT 1;
        """
        cursor.execute(query, (phone, phone))
        row = cursor.fetchone()

        cursor.close()
        conn.close()

        if row:
            response = {"found": True, "customer": row}
        else:
            response = {"found": False, "customer": None}

        return func.HttpResponse(
            json.dumps(response, default=str),
            status_code=200,
            mimetype="application/json",
        )

    except Exception as e:
        logging.exception("Erreur dans get_caller_info")
        return func.HttpResponse(
            json.dumps({"error": str(e)}),
            status_code=500,
            mimetype="application/json",
        )
