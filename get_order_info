import logging
import os
import json

import azure.functions as func
import mysql.connector


def _get_db_connection():
    return mysql.connector.connect(
        host=os.environ["MYSQL_HOST"],
        database=os.environ["MYSQL_DB"],
        user=os.environ["MYSQL_USER"],
        password=os.environ["MYSQL_PASSWORD"],
    )


def main(req: func.HttpRequest) -> func.HttpResponse:
    logging.info("get_order_info - Requête reçue.")

    customer_id = req.params.get("customer_id")
    phone = req.params.get("phone")

    if not customer_id and not phone:
        try:
            body = req.get_json()
        except ValueError:
            body = {}
        customer_id = body.get("customer_id")
        phone = body.get("phone")

    if not customer_id and not phone:
        return func.HttpResponse(
            json.dumps({"error": "Need 'customer_id' or 'phone'"}),
            status_code=400,
            mimetype="application/json",
        )

    try:
        conn = _get_db_connection()
        cursor = conn.cursor(dictionary=True)

        # Si on a seulement le téléphone, on va chercher l'id client
        if not customer_id and phone:
            cursor.execute(
                """
                SELECT id
                FROM customers
                WHERE phone = %s OR external_id = %s
                LIMIT 1;
                """,
                (phone, phone),
            )
            row = cursor.fetchone()
            if not row:
                cursor.close()
                conn.close()
                return func.HttpResponse(
                    json.dumps(
                        {
                            "found": False,
                            "customer": None,
                            "devices": [],
                            "tickets": [],
                        }
                    ),
                    status_code=200,
                    mimetype="application/json",
                )
            customer_id = row["id"]

        # Infos client
        cursor.execute(
            """
            SELECT id, external_id, name, email, phone, company_name
            FROM customers
            WHERE id = %s;
            """,
            (customer_id,),
        )
        customer = cursor.fetchone()

        # Appareils du client
        cursor.execute(
            """
            SELECT d.id,
                   d.serial_number,
                   d.location,
                   d.status,
                   pm.brand,
                   pm.model,
                   pm.description
            FROM devices d
            JOIN printer_models pm
              ON d.printer_model_id = pm.id
            WHERE d.customer_id = %s;
            """,
            (customer_id,),
        )
        devices = cursor.fetchall()

        # Derniers tickets
        cursor.execute(
            """
            SELECT id,
                   status,
                   priority,
                   subject,
                   problem_description,
                   created_at,
                   updated_at
            FROM tickets
            WHERE customer_id = %s
            ORDER BY created_at DESC
            LIMIT 5;
            """,
            (customer_id,),
        )
        tickets = cursor.fetchall()

        cursor.close()
        conn.close()

        response = {
            "found": bool(customer),
            "customer": customer,
            "devices": devices,
            "tickets": tickets,
        }

        return func.HttpResponse(
            json.dumps(response, default=str),
            status_code=200,
            mimetype="application/json",
        )

    except Exception as e:
        logging.exception("Erreur dans get_order_info")
        return func.HttpResponse(
            json.dumps({"error": str(e)}),
            status_code=500,
            mimetype="application/json",
        )
